{% extends 'child_base.html' %}
{% load static %}
{% load i18n %}
{% block title %}{% trans "××¡×š ×”×‘×™×ª - Volunteen" %}{% endblock %}
{% block extra_head %}
  <link rel="stylesheet" href="{% static 'childApp/css/child_home.css' %}">
{% endblock %}
{% block content %}

<div class="header-section">
    <h1 class="welcome-message">{% blocktrans with username=child.user.username %}×‘×¨×•×š ×”×‘×, {{ username }}!{% endblocktrans %}</h1>
    <p class="tagline">{{ greeting|safe }}</p>
</div>
{% if can_show_expiration_warning %}
<div class="premium-warning">
  <div class="warning-content">
    <h2>{% trans "×¨×•×¦×™× ×œ×”××©×™×š ×œ×™×”× ×•×ª ××•×•×œ×•× ×˜×™×Ÿ?" %}</h2>
    <p>{% blocktrans with days=days_left_to_expire %}×”×× ×•×™ ×©×œ×š ××ª×§×¨×‘ ×œ×¡×™×•× ×‘×¢×•×“ {{ days }} ×™××™×.<br>
    ×›×“×™ ×œ× ×œ×¤×¡×¤×¡ ××©×™××•×ª, ×¤×¨×¡×™× ×•×”×¤×ª×¢×•×ª â€“ ××¤×©×¨ ×œ×—×“×© ×•×œ×”×™×©××¨ ××™×ª× ×• ×‘×”×¨×¤×ª×§×”!{% endblocktrans %}</p>
    <a href="https://wa.me/972522865816?text=×©×œ×•×,%20×× ×™%20×¨×•×¦×”%20×œ×”×¦×˜×¨×£%20×œ×•×•×œ×•× ×˜×™×Ÿ!%20%F0%9F%8C%9F%0A×× ×™%20%5B×”×•×¨×”%2F×™×œ×“%2F×¢×¡×§%2F××•×¡×“%5D%20%F0%9F%93%9D%0A×©××™%3A%20" class="warning-cta">
    {% trans "×œ×—×“×© ×× ×•×™" %}
    </a>
  </div>
</div>
{% endif %}



<div class="avatar-streak-container redesigned" dir="rtl">
  <!-- Avatar bubble -->
  <div class="avatar-badge">
    <img src="{% static 'images/volunteen_avatar_friendly_kid.png' %}"
         alt="{% trans 'Avatar' %}" class="avatar-image">
  </div>

  <!-- Streak card -->
  <div class="streak-card">
    <div id="lottie-flame" class="flame">
        <dotlottie-player
            src="https://lottie.host/5d7eaca0-d62f-478f-a426-f6b79cea57a3/AlRFMEcD5L.lottie"
            background="transparent"
            speed="1"
            loop
            autoplay
            ></dotlottie-player>

    </div>

    <h2 class="streak-title">{% trans "ğŸ”¥ ×¨×¦×£ ×”×”×ª×—×‘×¨×•×™×•×ª ×©×œ×š" %}</h2>
    <p class="streak-count">
      <strong id="streak-count">{{ child.streak_count }}</strong>
      {% trans "×™××™× ×‘×¨×¦×£" %}
    </p>

    <button id="streak-button"
            class="streak-btn"
            onclick="saveStreak()">
      {% trans "âœ… ×©××•×¨ ×¢×œ ×”×¨×¦×£ ×©×œ×š" %}
    </button>

    <p id="streak-success" class="streak-success">
      {% trans "ğŸ‰ ×›×œ ×”×›×‘×•×“! ×©××¨×ª ×¢×œ ×”×¨×¦×£ ×©×œ×š! ğŸ”¥" %}
    </p>
  </div>
</div>

<div class="user-info-panel">
    <div class="user-level">
        <i class="fas fa-star" style="color: gold; font-size: 1.5em;"></i>
        <span>{% trans "×”×¨××” ×©×œ×š:" %} <strong>{{ level_name }}</strong> ({{ level }})</span>
    </div>
    <div class="user-teencoins">
        <i class="fas fa-coins" style="color: #ffca28; font-size: 1.5em;"></i>
        <span>{% trans "×˜×™× ×§×•×™× ×¡ ×‘××¨× ×§:" %} <strong>{{ active_points }}</strong></span>
    </div>
</div>

<div class="cta-section">
    <button class="cta-button" onclick="scrollToTasks()">
        {% trans "×‘×•× × ××¡×•×£ ×¢×•×“ ×˜×™× ×§××•×™× ×¡!" %}
    </button>
</div>

<div class="progress-container">
    <p>{% trans "×”×ª×§×“××•×ª ×œ×¨××” ×”×‘××”:" %}</p>
    <div class="progress-bar">
        <div class="progress-bar-fill" style="width: {{ progress_percent }}%;"></div>
    </div>
    <span class="progress-bar-text">{{ progress_percent|floatformat:0 }}%</span>
</div>

<div class="qr-center-row">
  <button type="button" class="secret-code-button" onclick="openQRModal()" aria-label="{% trans '×—×‘×¨ ××‘×™× ×—×‘×¨ â€“ ×”×¦×’ ×§×•×“ QR' %}">
    <i class="fas fa-qrcode" aria-hidden="true"></i>
    {% trans "×—×‘×¨ ××‘×™× ×—×‘×¨ ğŸ“±" %}
  </button>
</div>


<!-- QR Modal -->
<div id="qrModal" class="qr-modal" aria-hidden="true" role="dialog" aria-labelledby="qrModalTitle">
  <div class="qr-modal__content">
    <button class="qr-modal__close" type="button" aria-label="{% trans '×¡×’×•×¨' %}" onclick="closeQRModal()">&times;</button>
    <h3 id="qrModalTitle" class="qr-modal__title">{% trans "×¡×¨×§×• ××ª ×”×§×•×“ ×•×”×¦×˜×¨×¤×• ×œ××©×—×§! ğŸ®" %}</h3>

    <img
      src="https://api.qrserver.com/v1/create-qr-code/?size=280x280&data={{ referral_url|urlencode }}"
      alt="{% trans '×§×•×“ QR ×œ×”×–×× ×”' %}"
      class="qr-modal__img"
      width="280" height="280"
    />
  </div>
</div>


{% if new_tasks_count > 0 %}
<div id="newTaskNotification" class="notification">
    <p>{% blocktrans with count=new_tasks_count %}×™×© ×œ×š {{ count }} ××©×™××•×ª ×—×“×©×•×ª!{% endblocktrans %}</p>
    
    <p>
        <a href="{% url 'childApp:child_active_list' %}" class="button close-button task-button">
            {% trans "×§×“×™××” ×œ××©×™××•×ª! ğŸ§¡" %}
        </a>
    </p>
        <button type="button" onclick="markTasksAsViewed()" class="button close-button">
            {% trans "×¡×™×× ×ª×™ ×›× ×§×¨×" %}
        </button>   
</div>
{% endif %}



<div class="navigation-grid">
    <a href="{% url 'childApp:child_active_list' %}" class="nav-button" style="background-color: #28a745;">
        <i class="fas fa-tasks"></i>
        <span>{% trans "×¨×©×™××ª ××©×™××•×ª" %}</span>
    </a>
    <a href="{% url 'childApp:reward' %}" class="nav-button" style="background-color: #ff4081;">
        <i class="fas fa-gift"></i>
        <span>{% trans "×¨×©×™××ª ×¤×¨×¡×™×" %}</span>
    </a>
    <a href="{% url 'childApp:child_redemption_history' %}" class="nav-button" style="background-color: #17a2b8;">
        <i class="fas fa-history"></i>
        <span>{% trans "×”×™×¡×˜×•×¨×™×™×ª ×¨×›×™×©×”" %}</span>
    </a>
    <a href="{% url 'childApp:child_not_approved_requests' %}" class="nav-button" style="background-color: #ff5722;">
        <i class="fas fa-clock"></i>
        <span>{% trans "×‘×§×©×•×ª ×‘×ª×”×œ×™×š" %}</span>
    </a>
    <a href="{% url 'childApp:child-campaigns' %}" class="nav-button" style="background-color: #c542a4;">
        <i class="fas fa-bullhorn"></i>
        <span>{% trans "×§××¤×™×™× ×™×" %}</span>
    </a>
    
    <a href="{% url 'childApp:child_points_history' %}" class="nav-button" style="background-color: #9175c8;">
        <i class="fas fa-coins"></i>
        <span>{% trans "×”×™×¡×˜×•×¨×™×™×ª ×˜×™× ×§×•×™× ×¡" %}</span>
    </a>
    <a href="{% url 'childApp:points_leaderboard' %}" class="nav-button" style="background-color: #ff9800;">
        <i class="fas fa-trophy"></i>
        <span>{% trans "×§×™×¨ ×”×ª×”×™×œ×”" %}</span>
    </a>
    <a href="{% url 'childApp:top_streaks' %}" class="nav-button" style="background-color: #f44336;">
        <i class="fas fa-fire"></i>
        <span>{% trans "×©×™×× ×™ ×¨×¦×£" %}</span>
    </a>
    <a href="{% url 'childApp:donation_leaderboard' %}" class="nav-button" style="background-color: #2196F3;">
        <i class="fas fa-donate"></i>
        <span>{% trans "×§×™×¨ ×”×ª×¨×•××•×ª" %}</span>
    </a>
    <a href="{% url 'childApp:child_invite_qr' %}" class="nav-button" style="background-color: #ff7a18;">
        <i class="fas fa-user-friends"></i>
        <span>{% trans "×”×–××Ÿ ×—×‘×¨×™×" %}</span>
    </a>
    <a href="{% url 'childApp:task_check_in_out' %}" class="nav-button" style="background-color: #ff5722;">
        <i class="fas fa-map-marker-alt"></i>
        <span>{% trans "×¦'×§ ××™×Ÿ/×××•×˜" %}</span>
    </a>
   
    <a
    href="{% url 'childApp:donate_coins' %}"
    class="nav-button"
    style="background-color: #8bc34a"
  >
    <i class="fas fa-hand-holding-heart"></i>
    <span>{% trans "×¦×“×§×”" %}</span>
  </a>
  <a href="{% url 'childApp:get_reviewed_tasks' %}" class="nav-button" style="background-color: #5d22ff;">
    <i class="fas fa-history"></i>
    <span>{% trans "×”×™×¡×˜×•×¨×™×™×ª ××©×™××•×ª" %}</span>
</a>
    <a href="{% url 'teenApp:logout_view' %}" class="nav-button nav-logout">
        <i class="fas fa-sign-out-alt"></i>
        <span>{% trans "×™×¦×™××”" %}</span>
    </a>
</div>

<div class="language-selector-container">
    
    <label for="language-select" class="language-select-label">
        <i class="fas fa-globe" aria-hidden="true"></i>
        {% trans "×©× ×” ×©×¤×”" %}
    </label>
    
    <form action="{% url 'set_language' %}" method="post" class="language-select-form">
        {% csrf_token %}
        <input type="hidden" name="next" value="{{ request.path }}">
        
        <div class="language-select-wrapper">
            <select name="language" id="language-select" onchange="this.form.submit()" class="language-select-dropdown">
                {% get_current_language as LANGUAGE_CODE %}
                
                <option value="he" {% if LANGUAGE_CODE == 'he' %}selected{% endif %}>×¢×‘×¨×™×ª</option>
                <option value="ar" {% if LANGUAGE_CODE == 'ar' %}selected{% endif %}>Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
            </select>
        </div>
    </form>
</div>



{% endblock content %}

{% block extra_scripts %}
<script
  src="https://unpkg.com/@dotlottie/player-component@2.7.12/dist/dotlottie-player.mjs"
  type="module"
></script>
<script>

function showSecretCode() {
    document.getElementById('secretCodeModal').style.display = 'block';
}
function closeModal() {
    document.getElementById('secretCodeModal').style.display = 'none';
}

function markTasksAsViewed() {
    fetch("{% url 'childApp:mark_tasks_as_viewed' %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/json"
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('newTaskNotification').style.display = 'none';
            throwConfetti();
        }
    })
    .catch(error => console.error("Error:", error));
}

function scrollToTasks() {
    const tasksSection = document.getElementById('featuredTasks');
    tasksSection.scrollIntoView({behavior: 'smooth'});
}

document.addEventListener("DOMContentLoaded", function() {

    {% if new_tasks_count > 0 %}
        throwConfetti();
    {% endif %}
});


function showMedalPopup(name, description, points) {
    const popup = document.createElement('div');
    popup.className = 'medal-popup';
    popup.innerHTML = `
        <h2>ğŸ‰ ×–×›×™×ª ×‘××“×œ×™×” ×—×“×©×”! ğŸ‰</h2>
        <h3>${name}</h3>
        <p>${description}</p>
        <p>ğŸ… ×§×™×‘×œ×ª ${points} ×˜×™× ×§×•×™× ×¡!</p>
        <button onclick="closePopup()">×¡×’×•×¨</button>
    `;
    document.body.appendChild(popup);
}
function closePopup() {
    const popup = document.querySelector('.medal-popup');
    if (popup) {
        popup.remove();
    }
}
document.addEventListener("DOMContentLoaded", function() {
    const awardedMedals = JSON.parse('{{ awarded_medals|safe|escapejs }}');
    if (awardedMedals && awardedMedals.length > 0) {
        awardedMedals.forEach(medal => {
            showMedalPopup(medal.name, medal.description, medal.points_reward);
        });
    }
});
function saveStreak() {
    fetch("{% url 'childApp:update_streak' %}", {
        method: 'POST',
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/json"
        }
    })
    .then(response => response.json())
    .then(data => {
    if (data.success) {
        document.getElementById("streak-count").innerText = data.streak;
        document.getElementById("streak-success").style.display = "block";
        document.getElementById("streak-button").disabled = true;

        // logic for next milestone status
        const message = document.createElement("p");
        message.style.marginTop = "10px";
        message.style.fontWeight = "bold";
        message.style.color = "#333";
        message.style.fontSize = "0.95rem";

        const daysToNext = 10 - (data.streak % 10);
        if (data.reward_given) {
            alert(`ğŸ ×§×™×‘×œ×ª ×‘×•× ×•×¡ ×¢×œ ×¨×¦×£ ×©×œ ${data.milestone} ×™××™×!`);
            message.innerText = `×”×ª×—×œ×ª ×¨×¦×£ ×—×“×©! ×¢×•×“ 10 ×™××™× ×œ×‘×•× ×•×¡ ×”×‘× ğŸ’¥`;
        } else if (daysToNext !== 10) {
            message.innerText = `×¢×•×“ ${daysToNext} ×™××™× ×œ×‘×•× ×•×¡ ×”×‘× âœ¨`;
        }

        const streakSection = document.querySelector(".streak-card");
        if (streakSection && message.innerText) {
            streakSection.appendChild(message);
        }
    } else {
        alert(data.message);
    }
    })
    .catch(error => console.error("Error:", error));
}
function throwConfetti() {
    for (let i = 0; i < 40; i++) {
        createConfettiParticle();
    }
}
function createConfettiParticle() {
    const particle = document.createElement('div');
    particle.className = 'confetti';
    document.body.appendChild(particle);

    const left = Math.random() * 100;
    particle.style.left = left + "%";
    particle.style.animationDelay = Math.random() + 's';
    particle.style.backgroundColor = getRandomColor();

    particle.addEventListener('animationend', () => {
        particle.remove();
    });
}
function getRandomColor() {
    const colors = [
        "#f44336","#e91e63","#9c27b0","#673ab7","#3f51b5",
        "#2196f3","#03a9f4","#00bcd4","#009688","#4caf50",
        "#8bc34a","#cddc39","#ffeb3b","#ffc107","#ff9800",
        "#ff5722","#795548","#9e9e9e","#607d8b"
    ];
    return colors[Math.floor(Math.random() * colors.length)];
}
</script>
<script>
function openQRModal(){
  var m=document.getElementById('qrModal');
  if(m) m.style.display='block';
}
function closeQRModal(){
  var m=document.getElementById('qrModal');
  if(m) m.style.display='none';
}
// close on backdrop click
document.addEventListener('click',function(e){
  var m=document.getElementById('qrModal');
  if(!m) return;
  if(e.target===m) closeQRModal();
});
// close on ESC
document.addEventListener('keydown',function(e){
  if(e.key==='Escape') closeQRModal();
});
</script>


{% endblock extra_scripts %}
