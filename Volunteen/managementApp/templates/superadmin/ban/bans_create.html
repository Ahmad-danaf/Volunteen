{% extends "superadmin/superadmin_base.html" %}
{% load static %}

{% block extrahead %}
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          boxShadow: {
            glow: "0 10px 25px -5px rgba(255,140,66,0.35), 0 8px 10px -6px rgba(255,140,66,0.25)"
          },
          keyframes: {
            in: { "0%": { opacity: 0, transform: "translateY(6px) scale(0.98)" }, "100%": { opacity: 1, transform: "translateY(0) scale(1)" } },
            pingsoft: { "0%,100%": { transform: "scale(1)" }, "50%": { transform: "scale(1.02)" } }
          },
          animation: { in: "in .45s cubic-bezier(.2,.7,.2,1) forwards", pingsoft: "pingsoft 2.5s ease-in-out infinite" },
          colors: {
            brand: { 50:"#fff7ed",100:"#ffedd5",200:"#fed7aa",300:"#fdba74",400:"#fb923c",500:"#f97316",600:"#ea580c",700:"#c2410c",800:"#9a3412",900:"#7c2d12" }
          }
        }
      }
    };
  </script>
{% endblock %}

{% block content %}
<div class="mx-auto w-full max-w-xl px-4 py-6 sm:py-8" dir="rtl">
  <div class="mb-6 sm:mb-8 animate-in">
    <h1 class="text-3xl font-extrabold tracking-tight text-brand-600 text-center">
      יצירת חסימה חדשה
    </h1>
    <p class="mt-2 text-center text-sm text-gray-600">
      הגדרו חסימה לילד(ים): בחרו תחום, תאריכים והודעות.
    </p>
  </div>

  <form id="banForm" method="post" class="space-y-6 sm:space-y-7 animate-in">
    {% csrf_token %}

    <!-- Scope (segmented control) -->
    <section class="rounded-2xl border border-gray-200 bg-white p-4 shadow-sm">
      <div class="mb-3 flex items-center justify-between">
        <label class="text-base font-bold text-gray-900">תחום החסימה</label>
        <span class="text-xs text-gray-500">ברירת מחדל: רכישות</span>
      </div>
      <input type="hidden" id="scope" name="scope" value="{{ scope_choices.0.0 }}">
      <div class="grid grid-cols-3 gap-2">
        {% for value,label in scope_choices %}
         <button type="button"
                class="scope-btn rounded-xl border px-3 py-2 text-sm font-semibold transition
                      bg-gray-50 text-gray-700 border-gray-300
                      hover:border-brand-400 hover:text-brand-600
                      data-[active=true]:bg-brand-600 data-[active=true]:text-white data-[active=true]:border-brand-600"
                data-value="{{ value }}"
                data-label="{{ label }}">
          {{ label }}
        </button>


        {% endfor %}
        <p class="text-xs text-orange-600 mt-2 col-span-3">
          ⚠️ כרגע ניתן ליצור חסימה רק לרכישות. חסימות קמפיין מתבצעות זמנית דרך CampaignManager.
        </p>
      </div>
    </section>

    <!-- Severity (hard only) -->
    <section class="rounded-2xl border border-gray-200 bg-white p-4 shadow-sm">
      <label for="severity" class="mb-2 block text-base font-bold text-gray-900">רמת חומרה</label>
      <select id="severity" name="severity" class="w-full rounded-xl border-gray-300 text-gray-900 focus:border-brand-400 focus:ring-brand-400">
        <option value="hard" selected>חמור</option>
      </select>
      <p class="mt-1 text-xs text-gray-500">כרגע זמין רק "חמור".</p>
    </section>

    <!-- Starts/Ends + presets -->
    <section class="rounded-2xl border border-gray-200 bg-white p-4 shadow-sm">
      <div class="mb-4 grid grid-cols-1 gap-4">
        <div>
          <label for="starts_at" class="mb-1 block text-sm font-bold text-gray-900">תאריך התחלה</label>
          <input type="datetime-local"
                 id="starts_at"
                 name="starts_at"
                 value="{{ now|date:'Y-m-d\\TH:i' }}"
                 class="w-full rounded-xl border-gray-300 text-gray-900 focus:border-brand-400 focus:ring-brand-400" />
        </div>

        <div>
          <div class="mb-1 flex items-center justify-between">
            <label for="ends_at" class="block text-sm font-bold text-gray-900">תאריך סיום</label>
            <span id="endsHint" class="text-xs text-gray-500">ניתן לבחור מראש</span>
          </div>
          <input type="datetime-local"
                 id="ends_at"
                 name="ends_at"
                 class="w-full rounded-xl border-gray-300 text-gray-900 focus:border-brand-400 focus:ring-brand-400" />
        </div>
      </div>

      <div class="mt-1">
        <div class="mb-2 text-sm font-bold text-gray-900">קיצורי דרך</div>
        <div class="flex flex-wrap gap-2">
          {% for value,label in preset_choices %}
            <button type="button"
                    class="preset-btn rounded-full border px-3 py-1.5 text-xs font-semibold text-gray-700
                           hover:border-brand-300 hover:text-brand-700 transition active:scale-[0.98]"
                    data-preset="{{ value }}">{{ label }}</button>
          {% endfor %}
        </div>
        <p class="mt-2 text-[11px] text-gray-500">לחיצה על קיצור משתמשת בתאריך ההתחלה ומגדירה סיום בהתאם.</p>
      </div>
    </section>

    <!-- Children picker (search + checkbox select box) -->
<section class="rounded-2xl border border-gray-200 bg-white p-4 shadow-sm">
  <div class="mb-3 flex items-center justify-between">
    <label class="text-base font-bold text-gray-900">בחר ילדים</label>
    <span id="selCount" class="rounded-full bg-brand-50 px-2 py-0.5 text-xs font-bold text-brand-700">0 נבחרו</span>
  </div>

  <div class="flex items-center gap-2 mb-3">
    <input id="childSearch" type="text" inputmode="search" placeholder="חיפוש לפי שם משתמש…"
           class="w-full rounded-xl border-gray-300 text-gray-900 placeholder-gray-400
                  focus:border-brand-400 focus:ring-brand-400" />
    <button type="button" id="clearSearch"
            class="shrink-0 rounded-xl border px-3 py-2 text-xs font-semibold text-gray-700 hover:border-brand-300">
      נקה
    </button>
  </div>

  <!-- actions -->
  <div class="mb-2 flex items-center gap-2 text-xs">
    <button type="button" id="selectVisible"
            class="rounded-full border px-3 py-1.5 font-semibold text-gray-700 hover:border-brand-300 hover:text-brand-700">
      בחר את המוצגים
    </button>
    <button type="button" id="clearAll"
            class="rounded-full border px-3 py-1.5 font-semibold text-gray-700 hover:border-brand-300 hover:text-brand-700">
      נקה בחירה
    </button>
  </div>

  <!-- roller box -->
  <div id="childBox"
       class="max-h-72 overflow-y-auto rounded-xl border border-gray-200 divide-y divide-gray-100">
    {% for c in children %}
      <label class="flex items-center gap-3 p-3 child-row">
        <input type="checkbox" class="child-check h-5 w-5 rounded border-gray-300 text-brand-600 focus:ring-brand-400"
               value="{{ c.id }}" data-username="{{ c.username|lower }}">
        <span class="text-sm font-medium text-gray-900 truncate">{{ c.username }}</span>
      </label>
    {% endfor %}
  </div>

  <div id="chips" class="mt-3 flex flex-wrap gap-2"></div>

  <input type="hidden" id="child_ids" name="child_ids" value="" />
</section>


    <!-- Notes -->
    <section class="rounded-2xl border border-gray-200 bg-white p-4 shadow-sm">
      <div class="mb-2 flex items-center justify-between">
        <label for="note_child" class="text-base font-bold text-gray-900">הודעה גלויה לילד (עד 140 תווים)</label>
        <span id="childNoteCount" class="text-xs text-gray-500">0/140</span>
      </div>
      <textarea id="note_child" name="note_child" maxlength="140" rows="3"
                class="w-full rounded-xl border-gray-300 text-gray-900 placeholder-gray-400
                       focus:border-brand-400 focus:ring-brand-400"
                placeholder="הודעת ברירת מחדל לפי תחום החסימה תופיע כאן…"></textarea>

      <label for="note_staff" class="mt-4 mb-2 block text-base font-bold text-gray-900">הערה פנימית לצוות</label>
      <textarea id="note_staff" name="note_staff" rows="3"
                class="w-full rounded-xl border-gray-300 text-gray-900 placeholder-gray-400
                       focus:border-brand-400 focus:ring-brand-400"
                placeholder="אופציונלי: מידע פנימי לצוות"></textarea>
    </section>

    <!-- Submit -->
    <div class="sticky bottom-3 z-10">
      <button type="submit"
              class="w-full rounded-2xl bg-brand-600 px-4 py-3 text-center text-white text-base font-extrabold
                     shadow-glow transition hover:bg-brand-700 active:scale-[0.99]">
        שמירה והחלה
      </button>
    </div>
  </form>
</div>

<script>
  window.DEFAULT_NOTES = {{ default_notes|safe }};
  window.PURCHASE_KEY = "{{ scope_choices.0.0 }}";
</script>
<script src="{% static 'superadmin/js/bans_create.js' %}"></script>

{% endblock %}
