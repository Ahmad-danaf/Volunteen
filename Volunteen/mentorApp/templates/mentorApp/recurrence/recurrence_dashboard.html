{% extends 'mentor_primary_base.html' %}
{% load static %}

{% block extra_css %}
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { heebo: ['Heebo','system-ui','sans-serif'] },
          boxShadow: {
            'card': '0 10px 24px rgba(0,0,0,0.10)',
            'glow': '0 0 0 3px rgba(255,102,0,.18)',
          },
          colors: {
            brand: {
              50:'#FFF3E8', 100:'#FFE3CC', 200:'#FFCB99', 300:'#FFB266',
              400:'#FF9833', 500:'#FF7A18', 600:'#FF6600', 700:'#E25500'
            }
          },
          keyframes: {
            'sheet-in': { '0%': { transform:'translateY(100%)' }, '100%': { transform:'translateY(0)' } },
            'fade-in': { '0%': { opacity:0 }, '100%': { opacity:1 } },
            'pop': { '0%': { transform:'scale(.96)', opacity:.6 }, '100%': { transform:'scale(1)', opacity:1 } },
          },
          animation: {
            'sheet-in': 'sheet-in .35s cubic-bezier(.22,1,.36,1)',
            'fade-in': 'fade-in .25s ease-out',
            'pop': 'pop .18s ease-out',
          }
        }
      }
    }
  </script>
{% endblock %}

{% block content %}
<div dir="rtl" class="font-heebo bg-gradient-to-b from-white to-slate-50 min-h-[80vh]">

 <!-- Hero -->
<section class="sticky top-0 z-20 bg-white/80 backdrop-blur border-b border-slate-100">
  <div class="px-3 py-3">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-lg sm:text-xl font-bold text-brand-700 leading-tight">משימות חוזרות שלי</h1>
        <p class="text-slate-600 text-xs sm:text-sm mt-0.5">נהל כאן את כל תבניות המשימות שהוגדרו כחוזרות</p>
      </div>

      <a href="{% url 'mentorApp:template_list' %}"
         class="shrink-0 rounded-xl border border-brand-200 text-brand-700 bg-brand-50 px-3 py-1.5 text-sm sm:text-base font-semibold hover:bg-brand-100 transition">
        <span class="hidden sm:inline">+ הוסף</span>
        <span class="sm:hidden">+</span>
      </a>
    </div>

    <!-- Filters -->
    <form id="filtersForm"
          class="mt-3 grid grid-cols-2 sm:flex sm:flex-wrap sm:items-center gap-2 w-full">

      <!-- Search -->
      <input id="qInput" name="q" type="search" placeholder="חפש לפי כותרת…"
             class="col-span-2 sm:flex-1 rounded-xl border border-slate-200 bg-white px-3 py-2 text-slate-700 text-sm focus:outline-none focus:shadow-glow" />

      <!-- Status -->
      <select id="statusSelect" name="status"
              class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-slate-700 text-sm focus:outline-none">
        <option value="all">הכל</option>
        <option value="active">פעילות</option>
        <option value="inactive">מושבתות</option>
      </select>

      <!-- Frequency -->
      <select id="freqSelect" name="freq"
              class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-slate-700 text-sm focus:outline-none">
        <option value="">תדירות</option>
        <option value="daily">יומי</option>
        <option value="every_x_days">כל X ימים</option>
        <option value="weekly">שבועי</option>
        <option value="monthly">חודשי</option>
      </select>

      <!-- Apply Button -->
      <button id="applyBtn" type="submit"
              class="col-span-2 sm:col-auto rounded-xl bg-gradient-to-tr from-brand-500 to-brand-600 text-white px-3 py-2 font-semibold text-sm shadow hover:opacity-95 active:scale-[.98] transition">
        החל
      </button>
    </form>
  </div>
</section>


  <!-- Cards container -->
  <section class="p-4">
    <!-- Empty state -->
    <div id="emptyState" class="hidden rounded-2xl border border-dashed border-slate-300 bg-white text-center p-8 animate-fade-in">
      <div class="mx-auto w-16 h-16 rounded-2xl bg-gradient-to-br from-slate-100 to-slate-200 flex items-center justify-center shadow-card">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7 text-slate-500" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7v10M12 7v10M16 7v10M4 5h16M4 19h16"/>
        </svg>
      </div>
      <h3 class="mt-3 font-bold text-slate-800">אין משימות חוזרות</h3>
      <p class="text-slate-600 text-sm mt-1">לחץ “+ הוסף” כדי להגדיר חזרה חדשה</p>
    </div>

    <!-- Grid -->
    <div id="recGrid" class="grid grid-cols-1 gap-3"></div>

    <!-- Load more -->
    <div class="mt-4 flex justify-center">
      <button id="loadMoreBtn" class="hidden rounded-xl border border-slate-200 bg-white px-4 py-2 text-slate-700 hover:bg-slate-50 active:scale-[.99] transition">
        טען עוד
      </button>
    </div>
  </section>

  <!-- Edit Modal (bottom sheet) -->
  <div id="editSheet" class="fixed inset-0 z-30 hidden">
    <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" data-close-edit></div>
    <div class="absolute bottom-0 left-0 right-0 rounded-t-3xl bg-white shadow-card animate-sheet-in">
      <div class="p-4">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-bold text-brand-700">עריכת חזרה</h3>
          <button class="text-slate-500 text-2xl" data-close-edit>&times;</button>
        </div>

        <form id="editForm" class="mt-3 space-y-3">
          {% csrf_token %}
          <input type="hidden" id="editRecId"/>

          <!-- frequency -->
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-1">תדירות</label>
            <select id="efrequency" class="w-full rounded-xl border border-slate-200 px-3 py-2 focus:shadow-glow focus:outline-none">
              <option value="daily">יומי</option>
              <option value="every_x_days">כל X ימים</option>
              <option value="weekly">שבועי</option>
              <option value="monthly">חודשי</option>
            </select>
          </div>

          <!-- interval_days -->
          <div id="eIntervalWrap" class="hidden">
            <label class="block text-sm font-semibold text-slate-700 mb-1">מספר ימים</label>
            <input id="einterval_days" type="number" min="1"
                   class="w-full rounded-xl border border-slate-200 px-3 py-2 focus:shadow-glow focus:outline-none"
                   placeholder="לדוגמה: 3">
          </div>

          <!-- by_weekday -->
          <div id="eWeekdayWrap" class="hidden">
            <label class="block text-sm font-semibold text-slate-700 mb-1">ימי השבוע</label>
            <div class="grid grid-cols-7 gap-1 text-center">
              {# 0=Mon..6=Sun; show in RTL with Hebrew day names #}
              <label class="block"><input type="checkbox" value="0" class="weekdayChk"> ב׳</label>
              <label class="block"><input type="checkbox" value="1" class="weekdayChk"> ג׳</label>
              <label class="block"><input type="checkbox" value="2" class="weekdayChk"> ד׳</label>
              <label class="block"><input type="checkbox" value="3" class="weekdayChk"> ה׳</label>
              <label class="block"><input type="checkbox" value="4" class="weekdayChk"> ו׳</label>
              <label class="block"><input type="checkbox" value="5" class="weekdayChk"> ש׳</label>
              <label class="block"><input type="checkbox" value="6" class="weekdayChk"> א׳</label>
            </div>
          </div>

          <!-- day_of_month -->
          <div id="eMonthdayWrap" class="hidden">
            <label class="block text-sm font-semibold text-slate-700 mb-1">יום בחודש</label>
            <input id="eday_of_month" type="number" min="1" max="28"
                   class="w-full rounded-xl border border-slate-200 px-3 py-2 focus:shadow-glow focus:outline-none"
                   placeholder="לדוגמה: 15">
          </div>

          <!-- time -->
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-1">שעת הרצה</label>
            <input id="erun_time_local" type="time"
                   class="w-full rounded-xl border border-slate-200 px-3 py-2 focus:shadow-glow focus:outline-none"/>
          </div>

          <!-- dates -->
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-sm font-semibold text-slate-700 mb-1">תאריך התחלה</label>
              <input id="estart_date" type="date"
                     class="w-full rounded-xl border border-slate-200 px-3 py-2 focus:shadow-glow focus:outline-none"/>
            </div>
            <div>
              <label class="block text-sm font-semibold text-slate-700 mb-1">תאריך סיום (לא חובה)</label>
              <input id="eend_date" type="date"
                     class="w-full rounded-xl border border-slate-200 px-3 py-2 focus:shadow-glow focus:outline-none"/>
            </div>
          </div>

          <div class="flex gap-2 pt-1">
            <button id="saveEditBtn" type="submit"
                    class="flex-1 rounded-xl bg-gradient-to-tr from-brand-500 to-brand-600 text-white py-2 font-bold shadow hover:opacity-95 active:scale-[.99] transition">
              שמור
            </button>
            <button type="button" class="flex-1 rounded-xl border border-slate-200 bg-white py-2 font-semibold text-slate-700"
                    data-close-edit>ביטול</button>
          </div>
        </form>
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
const urls = {
  list: "{% url 'mentorApp:recurrence_list' %}",
  detail: (id) => "{% url 'mentorApp:recurrence_detail' 0 %}".replace('/0/', `/${id}/`),
  toggle: (id) => "{% url 'mentorApp:recurrence_toggle' 0 %}".replace('/0/', `/${id}/`),
  update: (id) => "{% url 'mentorApp:recurrence_update' 0 %}".replace('/0/', `/${id}/`),
  del:    (id) => "{% url 'mentorApp:recurrence_delete' 0 %}".replace('/0/', `/${id}/`),
  runs:   (id) => "{% url 'mentorApp:recurrence_runs' 0 %}".replace('/0/', `/${id}/`),
};

const state = {
  page: 1,
  pages: 1,
  q: "",
  status: "all",
  freq: "",
  loading: false,
};

const el = {
  grid: document.getElementById('recGrid'),
  empty: document.getElementById('emptyState'),
  loadMore: document.getElementById('loadMoreBtn'),
  filtersForm: document.getElementById('filtersForm'),
  qInput: document.getElementById('qInput'),
  statusSelect: document.getElementById('statusSelect'),
  freqSelect: document.getElementById('freqSelect'),

  // Edit sheet elements
  editSheet: document.getElementById('editSheet'),
  editForm: document.getElementById('editForm'),
  editRecId: document.getElementById('editRecId'),
  efrequency: document.getElementById('efrequency'),
  einterval_days: document.getElementById('einterval_days'),
  eweekdayWrap: document.getElementById('eWeekdayWrap'),
  eIntervalWrap: document.getElementById('eIntervalWrap'),
  eMonthdayWrap: document.getElementById('eMonthdayWrap'),
  eday_of_month: document.getElementById('eday_of_month'),
  erun_time_local: document.getElementById('erun_time_local'),
  estart_date: document.getElementById('estart_date'),
  eend_date: document.getElementById('eend_date'),
};

function getCSRFToken() {
  const name = 'csrftoken';
  const cookies = document.cookie ? document.cookie.split('; ') : [];
  for (const c of cookies) {
    const [k,v] = c.split('=');
    if (k === name) return decodeURIComponent(v);
  }
  // fallback to form token if exists
  const inp = el.editForm.querySelector('input[name=csrfmiddlewaretoken]');
  return inp ? inp.value : '';
}

/* --------- Fetch List --------- */
async function loadRecurrences({ reset=false }={}) {
  if (state.loading) return;
  state.loading = true;

  if (reset) {
    state.page = 1;
    el.grid.innerHTML = '';
  }

  const params = new URLSearchParams({
    page: state.page,
    page_size: 12,
  });
  if (state.q) params.set('q', state.q);
  if (state.status && state.status !== 'all') params.set('status', state.status);
  if (state.freq) params.set('freq', state.freq);

  try {
    const res = await fetch(`${urls.list}?${params.toString()}`);
    const json = await res.json();
    if (!json.success) throw new Error('failed');

    state.pages = json.pagination.pages || 1;

    const items = json.data || [];
    renderCards(items, { append: !reset });

    // Empty state / Load more
    el.empty.classList.toggle('hidden', items.length || el.grid.children.length);
    const more = state.page < state.pages;
    el.loadMore.classList.toggle('hidden', !more);

  } catch (e) {
    toast('שגיאה בטעינת הנתונים');
  } finally {
    state.loading = false;
  }
}

function renderCards(items, { append=true }={}) {
  const frag = document.createDocumentFragment();
  for (const rec of items) {
    frag.appendChild(card(rec));
  }
  if (append) el.grid.appendChild(frag);
  else {
    el.grid.innerHTML = '';
    el.grid.appendChild(frag);
  }
}

/* --------- Card Template --------- */
function card(rec) {
  const wrap = document.createElement('div');
  wrap.className = "rounded-2xl bg-white shadow-card p-3 active:scale-[.998] transition";
  wrap.innerHTML = `
    <div class="flex items-start gap-3">
      <img src="${rec.task_img || ''}" alt="${rec.task_title}"
           class="w-16 h-16 rounded-xl object-cover bg-slate-100 flex-shrink-0"
           onerror="this.src='${getStaticNoImage()}';"/>

      <div class="flex-1 min-w-0">
        <div class="flex items-start justify-between gap-2">
          <div class="min-w-0">
            <div class="font-bold text-slate-900 text-[15px] leading-snug">${escapeHtml(rec.task_title)}</div>
            <div class="mt-1 flex flex-wrap items-center gap-1">
              ${freqChip(rec)}
              ${rec.is_active
                ? `<span class="inline-flex items-center text-[11px] text-green-700 bg-green-50 border border-green-200 rounded-full px-2 py-[2px]">פעילה</span>`
                : `<span class="inline-flex items-center text-[11px] text-slate-600 bg-slate-50 border border-slate-200 rounded-full px-2 py-[2px]">מושבתת</span>`
              }
            </div>
          </div>

          <!-- Toggle -->
          <label class="inline-flex items-center cursor-pointer">
            <input type="checkbox" class="sr-only peer" ${rec.is_active ? 'checked':''}
                   data-toggle="${rec.id}">
            <div class="w-10 h-6 bg-slate-200 peer-checked:bg-brand-600 rounded-full relative transition">
              <span class="absolute top-0.5 right-[22px] peer-checked:right-0.5 h-5 w-5 bg-white rounded-full shadow transition-all"></span>
            </div>
          </label>
        </div>

        <div class="mt-2 text-[12px] text-slate-600">
          ${dateRow('הרצה הבאה', rec.next_run_at)}
          ${dateRow('התחלה', rec.start_date)} • ${dateRow('סיום', rec.end_date || 'ללא')}
          <div class="mt-1">${timeRow('שעה', rec.run_time_local)}</div>
        </div>

        <div class="mt-3 flex items-center gap-2">
          <button class="flex-1 rounded-xl bg-brand-50 text-brand-700 border border-brand-200 px-3 py-2 text-[13px] font-semibold hover:bg-brand-100"
                  data-edit="${rec.id}">
            ערוך
          </button>
          <button class="rounded-xl border border-slate-200 px-3 py-2 text-[13px] text-slate-700 hover:bg-slate-50"
                  data-runs="${rec.id}">
            יומן
          </button>
          <button class="rounded-xl border border-red-200 text-red-700 px-3 py-2 text-[13px] hover:bg-red-50"
                  data-del="${rec.id}">
            מחק
          </button>
        </div>

        <!-- Runs drawer -->
        <div class="mt-2 hidden" id="runs-${rec.id}">
          <div class="rounded-xl border border-slate-200 bg-slate-50 divide-y">
            <div class="p-2 text-[12px] text-slate-600">טוען יומן…</div>
          </div>
        </div>
      </div>
    </div>
  `;

  // Attach handlers
  const toggle = wrap.querySelector(`[data-toggle="${rec.id}"]`);
  toggle?.addEventListener('change', () => onToggle(rec.id, toggle.checked));

  const editBtn = wrap.querySelector(`[data-edit="${rec.id}"]`);
  editBtn?.addEventListener('click', () => openEdit(rec.id));

  const runsBtn = wrap.querySelector(`[data-runs="${rec.id}"]`);
  runsBtn?.addEventListener('click', () => toggleRuns(rec.id));

  const delBtn = wrap.querySelector(`[data-del="${rec.id}"]`);
  delBtn?.addEventListener('click', () => onDelete(rec.id));

  return wrap;
}

/* --------- Helpers to render small pieces --------- */
function freqChip(rec) {
  let text = rec.frequency_display || '';
  if (rec.frequency === 'every_x_days' && rec.interval_days) {
    text = `כל ${rec.interval_days} ימים`;
  }
  if (rec.frequency === 'weekly' && (rec.by_weekday || []).length) {
    const map = {0:'ב׳',1:'ג׳',2:'ד׳',3:'ה׳',4:'ו׳',5:'ש׳',6:'א׳'};
    const days = rec.by_weekday.map(d => map[d] ?? d).join(', ');
    text = `שבועי (${days})`;
  }
  if (rec.frequency === 'monthly' && rec.day_of_month) {
    text = `חודשי (יום ${rec.day_of_month})`;
  }
  return `<span class="inline-flex items-center text-[11px] text-brand-700 bg-brand-50 border border-brand-200 rounded-full px-2 py-[2px]">${escapeHtml(text)}</span>`;
}
function dateRow(label, iso) {
  if (!iso || iso === 'ללא') return `${label}: ${iso || '—'}`;
  const d = new Date(iso);
  if (isNaN(d.getTime())) return `${label}: —`;
  const dd = d.toLocaleDateString('he-IL');
  const tt = d.toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit'});
  // If it has time (next_run_at) show both; otherwise (date) show just date
  return `${label}: ${iso.length > 10 ? `${dd} ${tt}` : dd}`;
}
function timeRow(label, hhmm) {
  return `${label}: ${hhmm || '—'}`;
}
function getStaticNoImage() {
  return "{% static 'defaults/no-image.png' %}";
}
function escapeHtml(s='') {
  return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m]));
}

/* --------- Actions: toggle / edit / delete / runs --------- */
async function onToggle(id, isActive) {
  try {
    const res = await fetch(urls.toggle(id), {
      method: 'PATCH',
      headers: {'Content-Type': 'application/json','X-CSRFToken': getCSRFToken()},
      body: JSON.stringify({ is_active: !!isActive }),
    });
    const j = await res.json();
    if (!j.success) throw new Error();
    toast('סטטוס עודכן בהצלחה');
  } catch {
    toast('שגיאה בעדכון סטטוס');
  }
}

async function onDelete(id) {
  if (!confirm('האם למחוק את המשימה החוזרת?')) return;
  try {
    const res = await fetch(urls.del(id), {
      method: 'DELETE',
      headers: {'X-CSRFToken': getCSRFToken()},
    });
    const j = await res.json();
    if (!j.success) throw new Error();
    toast('נמחק בהצלחה');
    // Refresh list (keep filters, reset to page 1)
    state.page = 1;
    await loadRecurrences({ reset:true });
  } catch {
    toast('שגיאה במחיקה');
  }
}

async function toggleRuns(id) {
  const box = document.getElementById(`runs-${id}`);
  const visible = !box.classList.contains('hidden');
  if (visible) {
    box.classList.add('hidden');
    return;
  }
  box.classList.remove('hidden');
  box.innerHTML = `<div class="rounded-xl border border-slate-200 bg-slate-50 divide-y animate-fade-in">
      <div class="p-2 text-[12px] text-slate-600">טוען יומן…</div>
    </div>`;
  try {
    const res = await fetch(urls.runs(id));
    const j = await res.json();
    if (!j.success) throw new Error();
    const rows = (j.data || []).map(run => {
      const when = new Date(run.created_at).toLocaleString('he-IL', {hour:'2-digit', minute:'2-digit', day:'2-digit', month:'2-digit', year:'2-digit'});
      const label = run.status === 'created' ? '✅ נוצר' : (run.status === 'skipped' ? '⚠️ דילוג' : '⛔ שגיאה');
      const reason = run.reason ? `<div class="text-[11px] text-slate-500 mt-0.5">${escapeHtml(run.reason)}</div>` : '';
      return `<div class="p-2 text-[12px]">
        <div class="font-semibold text-slate-700">${label}</div>
        <div class="text-slate-600">${new Date(run.period_start).toLocaleDateString('he-IL')} • ${when}</div>
        ${reason}
      </div>`;
    }).join('') || `<div class="p-2 text-[12px] text-slate-600">אין רשומות ביומן</div>`;
    box.innerHTML = `<div class="rounded-xl border border-slate-200 bg-slate-50 divide-y animate-fade-in">${rows}</div>`;
  } catch {
    box.innerHTML = `<div class="rounded-xl border border-slate-200 bg-slate-50 divide-y">
      <div class="p-2 text-[12px] text-red-600">שגיאה בטעינת היומן</div>
    </div>`;
  }
}

/* --------- Edit Modal Logic --------- */
function openEdit(id) {
  // Prefill via detail endpoint
  fetch(urls.detail(id))
    .then(r => r.json())
    .then(j => {
      if (!j.success) throw new Error();
      const d = j.data;
      el.editRecId.value = d.id;
      el.efrequency.value = d.frequency || 'daily';
      el.einterval_days.value = d.interval_days || '';
      el.eday_of_month.value = d.day_of_month || '';
      el.erun_time_local.value = d.run_time_local || '08:00';
      el.estart_date.value = (d.start_date || '').slice(0,10);
      el.eend_date.value = (d.end_date || '').slice(0,10);

      // Weekday checkboxes
      const set = new Set(d.by_weekday || []);
      el.editForm.querySelectorAll('.weekdayChk').forEach(chk => {
        chk.checked = set.has(parseInt(chk.value));
      });

      // Show relevant frequency sections
      updateEditVisibility();

      // Open sheet
      el.editSheet.classList.remove('hidden');
    })
    .catch(() => toast('שגיאה בפתיחת העריכה'));
}

function closeEdit() {
  el.editSheet.classList.add('hidden');
}
document.querySelectorAll('[data-close-edit]').forEach(btn => btn.addEventListener('click', closeEdit));
el.efrequency.addEventListener('change', updateEditVisibility);

function updateEditVisibility() {
  const f = el.efrequency.value;
  el.eIntervalWrap.classList.toggle('hidden', f !== 'every_x_days');
  el.eweekdayWrap.classList.toggle('hidden', f !== 'weekly');
  el.eMonthdayWrap.classList.toggle('hidden', f !== 'monthly');
}

el.editForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  const id = el.editRecId.value;
  const f = el.efrequency.value;

  const payload = {
    frequency: f,
    interval_days: f === 'every_x_days' ? (el.einterval_days.value || null) : null,
    by_weekday: f === 'weekly' ? Array.from(el.editForm.querySelectorAll('.weekdayChk:checked')).map(x => x.value) : [],
    day_of_month: f === 'monthly' ? (el.eday_of_month.value || null) : null,
    run_time_local: el.erun_time_local.value || '08:00',
    start_date: el.estart_date.value || null,
    end_date: el.eend_date.value || null,
  };

  try {
    const res = await fetch(urls.update(id), {
      method: 'PATCH',
      headers: {'Content-Type':'application/json','X-CSRFToken': getCSRFToken()},
      body: JSON.stringify(payload),
    });
    const j = await res.json();
    if (!j.success) throw new Error();
    toast('נשמר בהצלחה');
    closeEdit();
    // Refresh list gracefully: reload first page with current filters
    state.page = 1;
    await loadRecurrences({ reset:true });
  } catch {
    toast('שגיאה בשמירה');
  }
});

/* --------- Filters & Pagination --------- */
el.filtersForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  state.q = el.qInput.value.trim();
  state.status = el.statusSelect.value;
  state.freq = el.freqSelect.value;
  state.page = 1;
  await loadRecurrences({ reset:true });
});

el.loadMore.addEventListener('click', async () => {
  if (state.page < state.pages) {
    state.page += 1;
    await loadRecurrences({ reset:false });
  }
});

/* --------- Toast --------- */
function toast(msg) {
  const t = document.createElement('div');
  t.className = "fixed bottom-4 left-1/2 -translate-x-1/2 z-50 bg-brand-700 text-white px-4 py-2 rounded-full shadow animate-pop";
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 2400);
}

/* --------- Init --------- */
document.addEventListener('DOMContentLoaded', () => {
  loadRecurrences({ reset:true });
});
</script>
{% endblock %}
