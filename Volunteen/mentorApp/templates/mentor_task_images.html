{% extends 'mentor_primary_base.html' %}
{% load static %}
{% load tz %}

{% block title %}סקירת הוכחות משימה{% endblock %}

{% block extra_head %}
<style>
  .animate-in { animation: fadeIn .25s ease-out both; }
  .animate-up { animation: slideUp .25s ease-out both; }
  @keyframes fadeIn { from {opacity:0} to {opacity:1} }
  @keyframes slideUp { from {transform:translateY(12px);opacity:.0} to {transform:translateY(0);opacity:1} }

  .elevate { box-shadow: 0 10px 30px -15px rgba(0,0,0,.15); }

  .focus-glow:focus { outline: none; box-shadow: 0 0 0 3px rgba(26,124,240,.25); }

  .tap { -webkit-tap-highlight-color: transparent; }

  .skeleton { background: linear-gradient(90deg,#f3f4f6 25%,#e5e7eb 37%,#f3f4f6 63%); background-size:400% 100%; animation: shimmer 1.2s ease-in-out infinite; }
  @keyframes shimmer { 0%{background-position: 100% 0} 100%{background-position: -100% 0} }
  #groupedView, #flatView { transition: opacity .3s ease; }
.hidden { opacity: 0; pointer-events: none; }
 .allow-wrap {
    white-space: normal !important;
    overflow: visible !important;
    text-overflow: unset !important;
    word-break: break-word;
  }

  .flex-1.min-w-0 {
    min-width: 8rem !important;
  }
  
</style>
<script>
  tailwind.config = {
    important: true
  }
</script>
<script src="https://cdn.tailwindcss.com"></script>

{% endblock %}

{% block content %}
<section class="min-h-screen bg-gray-50 pb-24" dir="rtl">
  <header id="stickyHeader"
        class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-gray-200 transition-shadow">

  <!-- ===== Title & Counter ===== -->
  <div class="px-4 pt-3 pb-2 flex items-center justify-between">
    <h1 class="text-xl font-extrabold tracking-tight text-gray-900">סקירת הוכחות</h1>
    <div class="text-xs text-gray-600">
      <span id="selectedCounter" class="font-semibold">נבחרו: 0</span>
    </div>
  </div>

  <!-- ===== Bulk Action Buttons  ===== -->
  <div class="px-3 pb-2 flex justify-between gap-2">
    <button class="flex-1 tap bg-green-600 text-white py-2 rounded-2xl text-sm font-semibold shadow hover:bg-green-700 transition"
            onclick="openApproveModal('full')">✅ אשר</button>

    <button class="flex-1 tap bg-amber-500 text-white py-2 rounded-2xl text-sm font-semibold shadow hover:bg-amber-600 transition"
            onclick="openApproveModal('partial')">⚖️ אשר חלקית</button>

    <button class="flex-1 tap bg-red-600 text-white py-2 rounded-2xl text-sm font-semibold shadow hover:bg-red-700 transition"
            onclick="openRejectModal()">❌ דחה</button>
  </div>

  <!-- ===== Secondary Controls ===== -->
  <!-- Secondary action buttons -->
<div class="px-4 pb-2 flex items-center justify-between gap-2 text-sm font-semibold">
  <button onclick="toggleSelectAll()"
          class="tap flex-1 bg-blue-50 text-blue-700 border border-blue-200 py-2 rounded-xl shadow-sm
                 hover:bg-blue-100 active:scale-[0.97] transition-all">
    בחר הכול
  </button>

  <button id="viewToggleBtn"
          onclick="toggleViewMode()"
          class="tap flex-1 bg-indigo-50 text-indigo-700 border border-indigo-200 py-2 rounded-xl shadow-sm
                 hover:bg-indigo-100 active:scale-[0.97] transition-all">
    הצג רשימה שטוחה
  </button>
</div>


  <!-- ===== Tabs ===== -->
  <div class="px-4 pb-3">
    <div class="grid grid-cols-2 gap-2">
      <button id="tabOnTime"
              class="tap tab-btn bg-blue-600 text-white rounded-2xl py-2 text-sm font-semibold shadow"
              data-target="#panelOnTime">בזמן</button>
      <button id="tabLate"
              class="tap tab-btn bg-gray-100 text-gray-700 rounded-2xl py-2 text-sm font-semibold"
              data-target="#panelLate">מאוחר</button>
    </div>

    <div class="mt-2 text-[12px] text-gray-500 text-center">
      <button class="tap underline" onclick="toggleSelectTab('#panelOnTime')">בחר הכול (בזמן)</button>
      <span class="mx-2">•</span>
      <button class="tap underline" onclick="toggleSelectTab('#panelLate')">בחר הכול (מאוחר)</button>
    </div>
  </div>
</header>


  <!-- ===== CONTENT PANELS ===== -->

  {% regroup on_time_completions by instance.task as ontime_grouped %}
  {% regroup late_completions by instance.task as late_grouped %}

  <!-- On-Time Panel -->
  <div id="groupedView">
    <div id="panelOnTime" class="animate-in">
      {% if ontime_grouped %}
        {% for group in ontime_grouped %}
        <section class="m-3 bg-white rounded-2xl shadow-sm overflow-hidden">
          <!-- Task header -->
          <header class="flex items-center justify-between p-3 border-b border-gray-100 bg-white">
            <div class="min-w-0">
              <h2 class="text-base font-bold text-gray-900 allow-wrap">{{ group.grouper.title }}</h2>
              <p class="text-xs text-gray-500 mt-0.5">סה״כ: {{ group.list|length }} הוכחות</p>
            </div>
            <div class="flex items-center gap-3">
              <button class="tap text-sm text-blue-700 font-semibold"
                      onclick="toggleTaskGroup('ontime-{{ forloop.counter }}')">בחר קבוצה</button>
              <button class="tap text-xs bg-gray-100 px-2 py-1 rounded-lg"
                      onclick="collapseToggle('ontime-wrap-{{ forloop.counter }}', this)">כווץ</button>
            </div>
          </header>

          <!-- Task items -->
          <div id="ontime-wrap-{{ forloop.counter }}" class="divide-y divide-gray-100">
            {% for item in group.list %}
              {% with comp=item.instance %}
              <label class="flex items-center gap-3 p-3 active:bg-gray-50">
                <input type="checkbox"
                      class="task-checkbox accent-blue-600 w-5 h-5"
                      value="{{ comp.id }}"
                      data-panel="panelOnTime"
                      data-group="ontime-{{ forloop.parentloop.counter }}"
                      onchange="updateCounter()">
                <div class="flex-1 min-w-0">
                 <div class="flex flex-col items-start">
  <div class="font-medium text-gray-900 truncate w-full">
    {{ comp.child.user.username|default:comp.child }}
  </div>
  <div class="text-[11px] text-gray-500 mt-0.5">
    {{ comp.completion_date|localtime|date:"d/m H:i" }}
  </div>
</div>

                  {% if comp.mentor_feedback %}
                    <div class="text-[11px] text-gray-500 mt-0.5 truncate">הערה קודמת: {{ comp.mentor_feedback }}</div>
                  {% endif %}
                </div>

                <!-- Thumbnails (lazy) -->
                <div class="flex gap-1 shrink-0">
                  {% if comp.checkin_img %}
                    <div class="h-12 w-12 rounded-lg overflow-hidden skeleton">
                      <img data-src="{{ comp.checkin_img.url }}"
                          alt="צ׳ק-אין"
                          class="lazy-img h-12 w-12 object-cover cursor-zoom-in"
                          onclick="openImage('{{ comp.checkin_img.url }}')">
                    </div>
                  {% endif %}
                  {% if comp.checkout_img %}
                    <div class="h-12 w-12 rounded-lg overflow-hidden skeleton">
                      <img data-src="{{ comp.checkout_img.url }}"
                          alt="צ׳ק-אאוט"
                          class="lazy-img h-12 w-12 object-cover cursor-zoom-in"
                          onclick="openImage('{{ comp.checkout_img.url }}')">
                    </div>
                  {% endif %}
                </div>
              </label>
              {% endwith %}
            {% endfor %}
          </div>
        </section>
        {% endfor %}
      {% else %}
        <p class="text-center text-gray-500 mt-6">אין הוכחות בזמן להצגה.</p>
      {% endif %}
    </div>

    <!-- Late Panel -->
    <div id="panelLate" class="hidden">
      {% if late_grouped %}
        {% for group in late_grouped %}
        <section class="m-3 bg-white rounded-2xl shadow-sm overflow-hidden">
          <header class="flex items-center justify-between p-3 border-b border-gray-100 bg-white">
            <div class="min-w-0">
              <h2 class="text-base font-bold text-gray-900 allow-wrap">
                {{ group.grouper.title }} <span class="text-xs text-amber-600">(מאוחר)</span>
              </h2>
              <p class="text-xs text-gray-500 mt-0.5">סה״כ: {{ group.list|length }} הוכחות</p>
            </div>
            <div class="flex items-center gap-3">
              <button class="tap text-sm text-blue-700 font-semibold"
                      onclick="toggleTaskGroup('late-{{ forloop.counter }}')">בחר קבוצה</button>
              <button class="tap text-xs bg-gray-100 px-2 py-1 rounded-lg"
                      onclick="collapseToggle('late-wrap-{{ forloop.counter }}', this)">כווץ</button>
            </div>
          </header>

          <div id="late-wrap-{{ forloop.counter }}" class="divide-y divide-gray-100">
            {% for item in group.list %}
              {% with comp=item.instance %}
              <label class="flex items-center gap-3 p-3 active:bg-gray-50">
                <input type="checkbox"
                      class="task-checkbox accent-blue-600 w-5 h-5"
                      value="{{ comp.id }}"
                      data-panel="panelLate"
                      data-group="late-{{ forloop.parentloop.counter }}"
                      onchange="updateCounter()">
                <div class="flex-1 min-w-0">
                 <div class="flex flex-col items-start">
  <div class="font-medium text-gray-900 truncate w-full">
    {{ comp.child.user.username|default:comp.child }}
  </div>
  <div class="text-[11px] text-gray-500 mt-0.5">
    {{ comp.completion_date|localtime|date:"d/m H:i" }}
  </div>
</div>

                  <div class="text-[11px] text-amber-600 mt-0.5">בדיקה: מאוחר</div>
                </div>

                <div class="flex gap-1 shrink-0">
                  {% if comp.checkin_img %}
                    <div class="h-12 w-12 rounded-lg overflow-hidden skeleton">
                      <img data-src="{{ comp.checkin_img.url }}"
                          alt="צ׳ק-אין"
                          class="lazy-img h-12 w-12 object-cover cursor-zoom-in"
                          onclick="openImage('{{ comp.checkin_img.url }}')">
                    </div>
                  {% endif %}
                  {% if comp.checkout_img %}
                    <div class="h-12 w-12 rounded-lg overflow-hidden skeleton">
                      <img data-src="{{ comp.checkout_img.url }}"
                          alt="צ׳ק-אאוט"
                          class="lazy-img h-12 w-12 object-cover cursor-zoom-in"
                          onclick="openImage('{{ comp.checkout_img.url }}')">
                    </div>
                  {% endif %}
                </div>
              </label>
              {% endwith %}
            {% endfor %}
          </div>
        </section>
        {% endfor %}
      {% else %}
        <p class="text-center text-gray-500 mt-6">אין הוכחות מאוחרות להצגה.</p>
      {% endif %}
    </div>
  </div>

  <!-- ===== Flat Mode ===== -->
<div id="flatView" class="hidden">
  {% for entry in on_time_completions %}
    {% with comp=entry.instance %}
      <label class="flex items-center gap-3 p-3 border-b border-gray-100 bg-white">
        <input type="checkbox" class="task-checkbox accent-blue-600 w-5 h-5"
               value="{{ comp.id }}" onchange="updateCounter()">

        <div class="flex-1">
          <div class="font-medium text-gray-900 truncate">
            {{ comp.child.user.username }}
          </div>
          <div class="text-xs text-gray-500">
            {{ comp.task.title }} — {{ comp.completion_date|date:"d/m H:i" }}
          </div>
        </div>

        <div class="flex gap-1 shrink-0">
          {% if comp.checkin_img %}
            <img data-src="{{ comp.checkin_img.url }}"
                 class="lazy-img h-12 w-12 object-cover rounded-lg cursor-zoom-in"
                 onclick="openImage('{{ comp.checkin_img.url }}')">
          {% endif %}
          {% if comp.checkout_img %}
            <img data-src="{{ comp.checkout_img.url }}"
                 class="lazy-img h-12 w-12 object-cover rounded-lg cursor-zoom-in"
                 onclick="openImage('{{ comp.checkout_img.url }}')">
          {% endif %}
        </div>
      </label>
    {% endwith %}
  {% endfor %}

  {% for entry in late_completions %}
    {% with comp=entry.instance %}
      <label class="flex items-center gap-3 p-3 border-b border-gray-100 bg-white">
        <input type="checkbox" class="task-checkbox accent-blue-600 w-5 h-5"
               value="{{ comp.id }}" onchange="updateCounter()">

        <div class="flex-1">
          <div class="font-medium text-gray-800 allow-wrap">
            {{ comp.child.user.username }}
          </div>
          <div class="text-xs text-gray-500">
            {{ comp.task.title }} — {{ comp.completion_date|date:"d/m H:i" }}
            <span class="text-amber-600">(מאוחר)</span>
          </div>
        </div>

        <div class="flex gap-1 shrink-0">
          {% if comp.checkin_img %}
            <img data-src="{{ comp.checkin_img.url }}"
                 class="lazy-img h-12 w-12 object-cover rounded-lg cursor-zoom-in"
                 onclick="openImage('{{ comp.checkin_img.url }}')">
          {% endif %}
          {% if comp.checkout_img %}
            <img data-src="{{ comp.checkout_img.url }}"
                 class="lazy-img h-12 w-12 object-cover rounded-lg cursor-zoom-in"
                 onclick="openImage('{{ comp.checkout_img.url }}')">
          {% endif %}
        </div>
      </label>
    {% endwith %}
  {% endfor %}
</div>

  <!-- ===== Bottom-Sheet Modal (Approve/Partial/Reject) ===== -->
  <div id="reviewModal" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/50" onclick="closeModal()"></div>
    <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl p-4 animate-up">
      <div class="mx-auto h-1 w-10 rounded-full bg-gray-200 mb-3"></div>
      <h3 id="modalTitle" class="text-lg font-extrabold text-gray-900 mb-2">אישור</h3>

      <div id="partialWrap" class="hidden">
        <label class="block text-sm font-semibold text-gray-700 mb-1">כמות נקודות (לכל הפריטים שנבחרו)</label>
        <input id="awardedCoins" type="number" min="1" inputmode="numeric"
               class="w-full border rounded-2xl px-3 py-2 focus-glow"
               placeholder="לדוגמה: 5">
        <p class="text-[11px] text-gray-500 mt-1">במקרה של אישור חלקי — יש להציב מספר נקודות קטן/שווה לנקודות המשימה.</p>
      </div>

      <label class="block text-sm font-semibold text-gray-700 mt-3 mb-1">הערת מנטור (לא חובה)</label>
      <textarea id="mentorFeedback"
                class="w-full border rounded-2xl px-3 py-2 h-20 focus-glow"
                placeholder="הקלד/י משוב קצר לילד/ה..."></textarea>

      <div class="flex gap-2 mt-4">
        <button id="submitBtn"
                class="flex-1 bg-blue-600 text-white py-2.5 rounded-2xl font-semibold shadow hover:bg-blue-700 transition"
                onclick="submitReviewAction()">אישור</button>
        <button class="flex-1 bg-gray-100 py-2.5 rounded-2xl font-semibold"
                onclick="closeModal()">ביטול</button>
      </div>
    </div>
  </div>

  <!-- ===== Fullscreen Image Viewer ===== -->
  <div id="imageViewer"
     class="hidden fixed inset-0 z-[60] bg-black/90 flex items-center justify-center p-4 cursor-pointer"
     onclick="closeImage()">
  <img id="viewerImg"
       class="max-h-[85vh] max-w-[95vw] rounded-2xl shadow-2xl animate-in pointer-events-none select-none"
       alt="Proof">
</div>



  <!-- ===== Toast ===== -->
  <div id="toast" class="hidden fixed bottom-4 right-4 left-4 mx-auto w-fit max-w-[90vw] px-3 py-2 rounded-xl text-sm text-white bg-gray-900/90 shadow-xl animate-in"></div>
</section>

<script>
  const CSRF_TOKEN = '{{ csrf_token }}';
  let flatMode = false;

  function toggleViewMode() {
  flatMode = !flatMode;
  document.getElementById('groupedView').classList.toggle('hidden', flatMode);
  document.getElementById('flatView').classList.toggle('hidden', !flatMode);

  const btn = document.getElementById('viewToggleBtn');
  btn.textContent = flatMode ? 'הצג לפי משימות' : 'הצג רשימה שטוחה';
}
  // ==== Sticky header elevation on scroll ====
  const stickyHeader = document.getElementById('stickyHeader');
  document.addEventListener('scroll', () => {
    if (window.scrollY > 8) stickyHeader.classList.add('elevate');
    else stickyHeader.classList.remove('elevate');
  });

  // ==== Tab switch ====
  const tabButtons = document.querySelectorAll('.tab-btn');
  tabButtons.forEach(btn => btn.addEventListener('click', () => {
    tabButtons.forEach(b => b.classList.remove('bg-blue-600','text-white'));
    tabButtons.forEach(b => b.classList.add('bg-gray-100','text-gray-700'));
    btn.classList.remove('bg-gray-100','text-gray-700');
    btn.classList.add('bg-blue-600','text-white');

    document.querySelectorAll('#panelOnTime, #panelLate').forEach(p => p.classList.add('hidden'));
    document.querySelector(btn.dataset.target).classList.remove('hidden');
  }));

  // ==== Lazy-load images with skeleton ====
  const lazyImgs = document.querySelectorAll('img.lazy-img');
  const io = new IntersectionObserver(entries => {
    entries.forEach(e => {
      if (e.isIntersecting) {
        const img = e.target;
        img.src = img.dataset.src;
        img.addEventListener('load', () => {
          img.parentElement.classList.remove('skeleton');
        }, { once: true });
        io.unobserve(img);
      }
    });
  }, { rootMargin: '200px 0px 200px 0px' });
  lazyImgs.forEach(img => io.observe(img));

  // ==== Fullscreen viewer ====
  function openImage(url) {
  const viewer = document.getElementById('imageViewer');
  const img = document.getElementById('viewerImg');
  img.src = url;
  viewer.classList.remove('hidden');
}

function closeImage() {
  const viewer = document.getElementById('imageViewer');
  const img = document.getElementById('viewerImg');
  viewer.classList.add('hidden');
  img.src = '';
}


  // ==== Select logic ====
  function updateCounter() {
    const count = document.querySelectorAll('.task-checkbox:checked').length;
    document.getElementById('selectedCounter').innerText = `נבחרו: ${count}`;
  }

  function toggleSelectAll() {
    const boxes = document.querySelectorAll('.task-checkbox');
    const anyUnchecked = Array.from(boxes).some(cb => !cb.checked);
    boxes.forEach(cb => cb.checked = anyUnchecked);
    updateCounter();
  }

  function toggleSelectTab(panelSelector) {
    const panel = document.querySelector(panelSelector);
    const boxes = panel.querySelectorAll('.task-checkbox');
    const anyUnchecked = Array.from(boxes).some(cb => !cb.checked);
    boxes.forEach(cb => cb.checked = anyUnchecked);
    updateCounter();
  }

  // Toggle per grouped task
  function toggleTaskGroup(groupKey) {
    const boxes = document.querySelectorAll(`.task-checkbox[data-group="${groupKey}"]`);
    const anyUnchecked = Array.from(boxes).some(cb => !cb.checked);
    boxes.forEach(cb => cb.checked = anyUnchecked);
    updateCounter();
  }

  // Collapse/expand task list
  function collapseToggle(id, btn) {
    const el = document.getElementById(id);
    el.classList.toggle('hidden');
    btn.textContent = el.classList.contains('hidden') ? 'פתח' : 'כווץ';
  }

  // ==== Modal flows ====
  let currentAction = 'approve'; // 'approve' | 'partial' | 'reject'
  function openApproveModal(kind) {
    currentAction = (kind === 'partial') ? 'partial' : 'approve';
    document.getElementById('modalTitle').textContent = (currentAction === 'partial') ? 'אישור חלקי' : 'אישור';
    document.getElementById('partialWrap').classList.toggle('hidden', currentAction !== 'partial');
    document.getElementById('reviewModal').classList.remove('hidden');
  }
  function openRejectModal() {
    currentAction = 'reject';
    document.getElementById('modalTitle').textContent = 'דחיית משימות';
    document.getElementById('partialWrap').classList.add('hidden');
    document.getElementById('reviewModal').classList.remove('hidden');
  }
  function closeModal() {
    document.getElementById('reviewModal').classList.add('hidden');
  }

  // ==== Toast helper ====
  function showToast(text, ok=true) {
    const t = document.getElementById('toast');
    t.textContent = text;
    t.classList.remove('hidden');
    t.style.background = ok ? 'rgba(17,24,39,.92)' : 'rgba(220,38,38,.92)';
    setTimeout(() => t.classList.add('hidden'), 2200);
  }

  // ==== Submit bulk review ====
  async function submitReviewAction() {
    const ids = Array.from(document.querySelectorAll('.task-checkbox:checked')).map(cb => cb.value);
    if (!ids.length) { showToast('לא נבחרו משימות.', false); return; }

    const payload = {
      task_ids: ids,
      action: (currentAction === 'reject') ? 'reject' : 'approve',
      mentor_feedback: document.getElementById('mentorFeedback').value || null
    };

    if (currentAction === 'partial') {
      const val = document.getElementById('awardedCoins').value;
      if (!val || Number(val) <= 0) { showToast('נא להזין כמות נקודות תקינה.', false); return; }
      payload.awarded_coins = Number(val);
    }

    // Button loading state
    const submitBtn = document.getElementById('submitBtn');
    const prevText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = 'מבצע...';

    try {
      const res = await fetch("{% url 'mentorApp:review_task' %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": CSRF_TOKEN,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(payload)
      });
      const json = await res.json();
      if (json.success) {
        showToast(json.message || 'בוצע בהצלחה ✅', true);
        // Soft reload after short pause for nicer UX
        setTimeout(() => window.location.reload(), 700);
      } else {
        showToast(json.error || 'שגיאה בביצוע.', false);
      }
    } catch (e) {
      showToast('שגיאת רשת. נסה/י שוב.', false);
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = prevText;
      closeModal();
    }
  }
</script>
{% endblock %}
